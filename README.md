# PlanarReflection (URP)

鏡面反射作りました。

ゆくゆくは水面とか作りたいかもしれない。

![img1](https://booth.pximg.net/7ae40447-3f13-4c32-a1ae-d4f9cd2c3b8f/i/4606386/b3d78f83-02ac-4dd4-b8e8-d908c30d9172.png)

## 利用規約

あまり厳しくはないです。

・改変等、自由に利用 OK

・本プログラムにおいていかなる障害が生じても作者は一切の責任を負いません。プログラムの利用は自己責任のもとおこなってください。

・本プログラム利用時に上記規約に同意したとみなします。

## 使い方

**コアライブラリが必須**です。

以下からDLをお願いします。

https://pinomatcha.booth.pm/items/4606120

コアライブラリのインポートが終わった後、BOOTHから本体をDLします。

1. .unitypackageをインポートします。
2. 「Mirror」プレファブを配置します。
3. あとはお好みで。

## 使い方（中級編）

1. .unitypackageをインポートします。
2. 任意の板状オブジェクトに「PlanarReflectionHandler」を追加します。
3. 「Mirror」マテリアルをアタッチします。
4. パラメータを設定します。
5. あとはお好みで。

マテリアルは「_ReflectionTex」にスクリプトからRenderTextureを指定しているだけなので自作のも使えると思います。

## 開発環境/動作環境

OS : Windows10

Unity : 2020.3.45f1

UniversalRP : 10.10.1

## 更新履歴

[v1.0.0] リリース

ー

## 配布場所

BOOTHに置いてあります。

以下リンクです。

https://pinomatcha.booth.pm/items/4606386

## パラメータ詳細

![inspec](https://booth.pximg.net/7ae40447-3f13-4c32-a1ae-d4f9cd2c3b8f/i/4606386/81e18c52-3c21-4da1-aace-f2baafead9fa.png)

### Main Camera

このカメラを元に反射用カメラのマトリックスを算出します。

nullの場合は自動でメインカメラを取得します。

### 反射用オブジェクト

反射を表示する板状のオブジェクトです。

板状じゃないとバグります。たぶん。

通常はローカル+Y方向（Transform.up）が反射面になります。

変更は下記の項目でできます。

### 反射面上書き

セットすると計算上はこちらのTransform.upを使用して計算します。

### 解像度倍率

その名の通りです。

0だとエラーになるので0.01～1の範囲で設定できます。

1だと画面解像度でレンダリングされます。

### 解像度をリアルタイムに変更する

これもその名の通りです。

チェックを入れると上記パラメータのスライダーの値が変更されたときに解像度更新の関数がコールされます。

PlanarReflectionHandler.ResizeRenderTexture();

### カリングマスク

反射用カメラのカリングマスクです。

### 描画間隔

反射用カメラのレンダリング間隔です。

ここの数字のフレーム間、レンダリング処理を待機します。
                
### フレームブレンドを使用

単純に3フレーム分のレンダリング結果をブレンドします。

残像みたいになります。

基本的にシェーダーは分かる人だけいじってください。

### ぼかしを使用

レンダリング結果にカーネルブラーを適応します。

『高品質』はカーネルブラーを2回縮小バッファに書き込むことでごまかします。

アップサンプリングはおこなっていません。

こちらもシェーダーは分かる人だけいじってください。

## 仕組み

簡単な仕組みを書き留めておきます。

分かる人はこれをもとにいじってください。

1. スクリプトからRenderTexture生成、反射用カメラのtargetにセットしておく
2. 基準のカメラから反射用カメラのマトリックスを算出
3. 反射用カメラにレンダリング命令
4. 反射用カメラのレンダリング結果がRenderTextureに描き込まれる
5. RenderTextureをブレンドとかブラーとか加工する
6. シェーダーでuvをScreenSpaceでサンプリング
7. 表示

なんとなくこんな感じです。たぶん。

## PlanarReflectionHandlerのPublic関数

### ResizeRenderTexture(float resolutionMultiplier)

RenderTextureのサイズを変更します。

引数は解像度倍率です。

インスペクタに表示されている変数を上書きはしないので『解像度倍率』と競合します。

引数を指定しない場合は自動で『解像度倍率』を取得して反映します。

『解像度をリアルタイムに変更する』は引数なしでこの関数を呼んでいるだけです。

### StopReflectionRendering()

反射処理を停止します。

### ResumeReflectionRendering()

反射処理を再開します。

初期化などはおこなっていません。
